#!/usr/bin/python

import sys
from os.path import exists
from yams import schema2dot
from yams.reader import SchemaLoader
from tempfile import NamedTemporaryFile
from subprocess import Popen

from logilab.common.configuration import Configuration

from yams.__pkginfo__ import version

options = [('output-file', {'type':'file', 'default': None,
             'metavar': '<file>', 'short':'o', 'help':'output image file'}),
           ('viewer', {'type': 'string', 'default':"rsvg-view", 'short': "w", 'metavar':'<cmd>',
             'help':'command use to view the generated file (empty for none)'}),
          ]

config = Configuration(options=options,
    usage="yams-view [[[...] deps] deps] apps",
    version=version)
config.load_command_line_configuration()
dirnames = sys.argv[1:]
for dir in dirnames:
    assert exists(dir), dir
schm_ldr = SchemaLoader()
schema = schm_ldr.load(dirnames)


out, viewer = config['output-file'], config['viewer']
if out is None:
    tmp_file = NamedTemporaryFile(suffix=".svg")
    out = tmp_file.name
schema2dot.schema2dot(schema, out, #size=size,
    skiprels=(), skipmeta=True)
if viewer:
    p = Popen((viewer, out))
    p.wait()
